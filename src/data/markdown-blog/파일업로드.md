## 웹브라우저를 통해 로컬 컴퓨터에 있는 파일을 S3로 업로드, 수정, 삭제하는 법

### 1. Local storage에 있는 파일을 서버로 전송한다.

- 웹브라우저에서 local stroage에 있는 파일을 읽는다. 뭘로 어떻게?
- 읽은 걸 서버로 전송한다. 뭘로 어떻게?

#### 1-1) input 태그를 사용해 local storage에 있는 파일을 읽는다.

![image-20181106215126663](/Users/jooyeon/Library/Application%20Support/typora-user-images/image-20181106215126663.png)

- form태그 하위의 input 태그로 파일 데이터를 선택한다. 이 때 input 태그의 type은 file이다.

  ㄴ 폼태그 외 다양한 방법으로 선택할 수 있다 : 다양한 웹 브라우저에서의 파일 활용 Using file from web applications : https://developer.mozilla.org/en-US/docs/Web/API/File/Using_files_from_web_applications

  ```javascript
  <Form
    action="www.diary.com/post/img"
    method="post"
    enctype="multipart/form-data"
  >
    <input type="file" id="imagefile" />
    <input type="submit" value="전송" />
  </Form>
  ```

- DOM에 추가된 File API를 사용한다.

- 태그의 id를 활용해 유저가 선택한 로컬 파일로 접근한다.

  ```html
  var selectedFile = document.getElementById('imagefile').files[0];
  ```

#### 1-2) FormData를 사용해 읽은 파일을 비동기로 서버에 보낼 수 있는 형식으로 만든다.

> 폼태그로 동기 전송 vs ajax로 비동기 전송
>
> - 폼은 제출 버튼을 누르면 action 속성에 지정한 페이지로 이동하면서 데이터 전송
>
> - ajax는 제출 버튼을 누르면 기본 폼 동작은 e.preventDefault()로 멈추고, 페이지 전환 없이 데이터를 전송.

- (참고) 동기로 파일을 보낼 때는 form태그의 enctype을 multipart/form-data으로 지정해주면 된다.

  ```javascript
  <Form
    action="www.diary.com/post/img"
    method="post"
    enctype="multipart/form-data"
  >
    <input type="file" id="imagefile" />
    <input type="submit" value="전송" />
  </Form>
  ```

  - 동기로 파일을 보낸다는 건 submit과 동시에 데이터를 전송한다는 것.

  - enctype은 인코딩 타입을 의미한다. 인코딩 = 데이터를 전송할 때 어떤 형식으로 보낼 거냐? enctype 지정 request.header의 Content-Type을 지정해주는 것. 지정하지 않으면 "application/x-www-form-urlencoded"이 디폴트 설정된다.

  - multipart/form-data로 설정하면 바이너리 데이터로 보내겠다는 것 (참고로 텍스트는 아스키 데이터) "application/x-www-form-urlencoded"는 대용량의 binary data나 텍스트를 담고있는 non-ASCII characters들을 전송하기에 비효율적이다.

    ㄴ content-type를 multipart/form-data로 지정했을 때 : https://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.2 && https://lng1982.tistory.com/209

* 비동기로 파일을 보내기 위해 파일을 서버로 보낼 수 있는 형식으로 만들어야 한다. 직접 바꾸거나, FormData를 활용해 만든다.

* 직접 바꾸는 건 복잡하다. 직접 보낼 수 있는 형식으로 만드는 법 (Building an XMLHttpRequest Manually) 참고 : https://developer.mozilla.org/en-US/docs/Learn/HTML/Forms/Sending_forms_through_JavaScript

* 그래서 FormData를 활용한다.

  - XMLHttpRequest를 사용하여 전송할 수 있도록 키/값 쌍들의 집합을 컴파일해준다.

  - window.FormData에 위치한다.

  - FormData를 사용할 경우 enctype이 multipart/form-data로 지정된다.

  - FormData를 사용해 키/값의 쌍을 컴파일하는 법

    ```javascript
    var form = new FormData();
    form.append("img", document.getElementById("imagefile").files[0]);
    ```

    - form의 values 확인하는 법 : https://developer.mozilla.org/ko/docs/Web/API/FormData/values

#### 1-3) Axios를 사용해 서버로 파일을 보낸다.

- 직접 XMLHttpRequest로 보내거나, HTTP클라이언트를 활용해 보낸다.

- XMLHttprequest로 보내는 건 상대적으로 복잡하다.

  - XMLHttprequest 보내는 법 : https://developer.mozilla.org/ko/docs/XMLHttpRequest

  ```javascript
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'www.mydiary.com/post/img');
  xhr.send(form); // 폼 데이터 객체 전송
  xhr.onload = function() { // 응답을 전송 받음
      if (xhr.status === 200 || xhr.status === 201) {
        cossole.log(xhr.responseText);
      } else {
        console.error(xhr.responseText);
      }
  ```

- 그래서 HTTP 클라이언트(라이브러리?)를 활용해 보낸다.

  ```javascript
  axios
      .post('www.mydiary.com/post/img', form)
      .then(res => res)
      .catch(err => err);
  };
  ```

  - Axios 라이브러리가 하는 일
    - 브라우저에서 XMLHttpRequests를 한다.
    - node.js에서 http 요청을 한다 등
    - axios에 대해 : https://www.npmjs.com/package/axios

### 2. 서버에서 파일을 받아 AWS S3(또 다른 서버)로 저장한다.

#### 2-1) multer, aws-sdk, multer-s3 모듈을 사용해 전송받은 파일을 어디에 저장할 건지 정의하고 저장한다.

- multer는 multipart/form-data를 다루기 위한 node.js express 미들웨어다.

  - multer가 뭐 하나? multipart/form-data 형식에 맞게 요청온 데이터를 처리하기 쉽게해준다.

    ㄴ request.body에 폼 텍스트의 필드 값 추가해준다.

    ㄴ request.file 객체에는 업로드된 파일 추가해준다.

    ㄴ multer 공식 매뉴얼 참고 : https://github.com/expressjs/multer/blob/master/doc/README-ko.md

- multer를 사용해 어디에 어떤 옵션으로 저장할 것인지 정의한다.

```javascript
const multer = require("multer");

// dest or storage은 기본 옵션. Multer에게 파일을 어디로 업로드할지 알려준다. dest는 디스크에 저장 등 간단히 정의할 때, storage는 업로드를 더 많이 제어하고싶을 때 쓴다.

// dest
const upload = multer({ dest: "uploads/" });

// storage
const storage = multer.diskStorage({
  destination: function(req, file, cb) {
    // 어떤 폴더에 저장할 건지
    cb(null, "/tmp/my-uploads");
  },
  filename: function(req, file, cb) {
    // 어떤 파일명으로 저장할 건지
    cb(null, file.fieldname + "-" + Date.now());
  }
});
const upload = multer({ storage: storage });
```

- 파일을 AWS S3에 저장하기 위해 aws-sdk 모듈로 AWS 서비스들에 접근한다.

  - aws-sdk로 접근할 수 있는 서비스 목록 : https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS.html

  ```javascript
  const AWS = require("aws-sdk");

  AWS.config.update({
    accessKeyId: process.env.S3_ACCESS_KEY_ID,
    secretAccessKey: process.env.S3_SECRET_ACCESS_KEY,
    region: "ap-northeast-2"
  });

  // s3 id와 key는 숨겨놔야한다.
  // S3_ACCESS_KEY_ID=AFSDFW5JPM6SV7XKZ5WA
  // S3_SECRET_ACCESS_KEY=TpSDFwFdsfdb/Nn5FWE@FFWE9oeFE

  const s3 = new AWS.S3();
  ```

* multer-s3 모듈을 사용해 AWS의 서버를 storage로 만들어준다.
  - multer-s3는 multer의 storage와 s3fs를 통합해서 사용할 수 있게 해준다.
    - multer-s3에 대해 : https://www.npmjs.com/package/multer-s3

```javascript
const multerS3 = require("multer-s3");

const upload = multer({
  storage: multerS3({
    s3: s3,
    bucket: "mydiarystorage",
    key(req, file, cb) {
      cb(null, `original/${+new Date()}${path.basename(file.originalname)}`);
    }
  }),
  limits: { fileSize: 5 * 1024 * 1024 }
});
```

#### 2-2) multer 모듈을 사용해 클라이언트에 저장된 파일 정보를 응답한다.

```javascript
app.post("/img", upload.single("img"), (req, res) => {
  var result = {
    url: req.file.location,
    key: req.file.key
  };
  res.json(result);
});
```

### 3. 파일을 S3에서 불러와 읽고, 삭제한다.

#### 3-1) 클라이언트/서버에 저장한 url, key 값으로 S3에 저장된 파일을 불러온다.

#### 3-2) aws-sdk 모듈을 사용해 파일을 삭제한다.

- aws-sdk 모듈을 활용해 s3 클래스의 deleteobject 메소드를 사용해 삭제한다.
  - aws-sdk 모듈을 통해 사용할 수 있는 모든 메소드 보기 : https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#deleteObject-property

```javascript
const params = {
  Bucket: "mydiarystorage",
  Key: req.body.key
};
await s3.deleteObject(params, function(err, data) {
  if (err) console.log(err, err.stack);
  else console.log(data);
});
```

요약

> - 클라이언트에서 form태그로 받은 데이터를 FormData에 담아 Axios로 보낸다.
> - 서버에서 multer 모듈로 데이터를 받아 aws-sdk와 multer-s3 모듈을 활용해 S3에 저장한다.
> - S3에 업로드된 파일의 url과 key 값으로 파일을 읽는다.
> - 클라이언트의 key값을 가지고, aws-sdk 모듈을 활용해 deleteObject 메소드를 써 삭제한다.
